{% extends 'anketa/profile.html' %}
{% load staticfiles %}
{% block additionalcss %}
<link href="{% static "anketa/css/prettify.css" %}" rel="stylesheet">
<link href="{% static "anketa/select2-3.5.4/select2.css" %}" rel="stylesheet">
<link href="{% static "anketa/select2-3.5.4/select2-bootstrap.css" %}" rel="stylesheet">
{% endblock %}
{% block scripts %}
<script src="{% static "anketa/js/jquery-1.11.0.min.js" %}"></script>
<script src="{% static "anketa/select2-3.5.4/select2.min.js" %}"></script>
<script src="{% static "anketa/js/prettify.js" %}"></script>
<script src="{% static "anketa/select2-3.5.4/select2_locale_ru.js" %}"></script>
<script>
	var $currentRow=null;
	var $rowscount=3;
	var $selectedprog="";
	function PopUp(row)
	{
		if($($currentRow).attr('id')==$(row).attr('id') && $("#applicationBlank").attr('class')=="panel panel-primary")
		{
			$(row).html("Редактировать");
			$("#applicationBlank").attr('class','panel panel-primary hidden');
		}
		else
		{
			var id=parseInt($(row).attr('id').slice('-1'));
			$($currentRow).html("Редактировать");
			$currentRow=$(row);
			$(row).html("Закрыть");
			$("#applicationBlank").attr('class','panel panel-primary');
			{% for item in applications %}
				{% if item.id == 8 %}
					$("#eduname").select2('enable');
					$("#eduprof").select2('enable');
					$("#eduprior").select2('enable');
					$("#eduform").select2('enable');
					$("#department").select2('data',{id: {{item.department.id}}, text:"{{ item.department.name }}"});
					$("#eduname").select2('data',{id: {{item.edu_prog.edu_prog.id}}, text:"{{ item.edu_prog.edu_prog.name }}"});
					//$("#eduform").select2('data',{id: {{item.edu_prog.eduform.id}}, text:"{{ item.edu_prog.eduform}}"});
					//$("#eduprior").select2('data',{id: {{item.department.id}}, text:"{{ item.department.name }}"});
					//$("#eduform").select2('data',{id: {{item.department.id}}, text:"{{ item.department.name }}"});
				{% endif %}
			{% endfor %}
		}
	};
	$(document).on("click","button[id*='application']", function()
	{
		PopUp($(this));
	});
	$("#add").on("click", function()
	{
		$currentRow=null;
		if($("#applicationBlank").attr('class')=="panel panel-primary")
		{
			$("#applicationBlank").attr('class','panel panel-primary hidden');
		}
		else
		{
			$("#applicationBlank").attr('class','panel panel-primary');
		}
	});
	$("#save").on("click", function()
	{
		$.ajax({
			url: {% url 'save_application' %},
			type:"POST",
			type:$("#applications").attr('method'),
			data:$("#applications").serialize(),
			dataProcess:true,
			timeout:500,
			success:function(data)
			{
				if($currentRow==null)
				{
					$rowscount++;
					$("#tablebody").append("<tr class='info'><td>"+ $("#department").val() + "</td> <td>"+ $("#eduname").val() + "</td> <td>"+ $("#eduprof").val() + "</td> <td>Подано</td> <td><button class='btn btn-default btn-sm' id='row"+$rowscount+"' type='button'>Редактировать</button></td></tr>");
				}
				else
				{
					$($currentRow).html("Редактировать");
				}
				$("#applicationBlank").attr('class','panel panel-primary hidden');
			},
			error:function()
			{
				alert("der'mishe");
			}
		});
	});
	$("#department").select2({
		language:"ru",
		ajax:{
			url:{% url 'institute' %},
			dataType:'json',
			delay:250,
			data:function(params){
				return{
					query:params
				};
			},
			processResults: function(data, page)
			{
				return{
					results:data,
				};
			},
			cache:true
		}
	});
	$('#eduname').select2({
		language:"ru",
		ajax:
		{
			url:{% url 'eduname' %},
			dataType: 'json',
			delay: 250,
			data:function(params){
				return{
					query: params, // search term
					id:$("#department").select2('data').id
				};
			},
			processResults: function (data, page) {
				return {
				  results: data,
				};
			},
			cache: true
		}
	});
	$('#eduprof').select2({
		language:"ru",
		multiple:true,
		ajax:{
			url:{% url 'eduprof' %},
			dataType:'json',
			delay:250,
			data:function(params){
				return{
					query:params,
					id:$("#eduname").select2('data').id
				};
			},
			processResults:function(data,page)
			{
				return{
					results:data
				};
			},
			cache:true
		}
	});
	$("#eduform").select2({
		language:"ru",
		ajax:{
			url:{% url 'eduform' %},
			dataType:'json',
			delay:250,
			data:function(params){
				return{
					query:params,
					id:$("#eduname").select2('data').id
				};
			},
			processResults:function(data,page)
			{
				return{
					results:data
				};
			},
			cache:true
		}
	});
	$("#eduprior").select2({
		language:"ru"
	});
	$('#department').on("select2-selecting", function(e) {
		$("#eduname").select2('enable');
	});
	$('#eduname').on("select2-selecting", function(e) {
		if($('#eduname').val())
		{
			if($selectedprog!=$('#eduname').select2('data').text)
			{
				$("#eduprof").select2('val',"");
				$("#eduprior").select2('val',"");
				$("#eduform").select2('val',"");
				//обнулить дерьмище
			}
		}
		$("#eduprof").select2('enable');
		$("#eduprior").select2('enable');
		$("#eduform").select2('enable');
		//открыть дерьмище
	});
</script>
{% endblock %}
{% block container %}
<form name="applications" id = "applications" action="" class="form-horizontal" role="form" method="post">
{% csrf_token %}
	<div class="col-md-9 col-xs-10 col-sm-8">
		<div class="row">
			<div class="col-md-12 col-xs-10 col-sm-8">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3 class="panel-title">Ваши заявления</h3>
					</div>
					<div class="panel-body">
						<div class="row">
							<table class="table" id="table">
								<thead id="tablehead">
									<tr>
										<th>Номер</th>
										<th>Институт/факультет</th>
										<th>Направление/специальность</th>
										<th>Статус</th>
										<th>Действие</th>
									</tr>
								</thead>
								<tbody id="tablebody">
								{% for item in applications %}
									<tr {% if item.appState.value == "Поданный" %} class="success" {% else %} class="info" {% endif %}>
										<td>{{item.id}}</td>
										<td>{{item.department}}</td>
										<td>{{item.edu_prog.edu_prog}}</td>
										<td>{{item.appState.value}}</td>
										<td><button class="btn btn-default btn-sm" id="application{{item.id}}" type="button">Редактировать</button></td>
									</tr>
								{% endfor %}
								</tbody>
							</table>
						</div>
						<div class="row">
							<button class="btn btn-primary btn-block" type="button" id="add">Добавить</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12 col-xs-10 col-sm-8">
				<div class="panel panel-primary hidden" id="applicationBlank" name="applicationBlank">
					<div class="panel-heading">
						<h3 class="panel-title">Заявление</h3>
					</div>
					<div class="panel-body">
						<div class="row">
							<div class="col-md-11 col-xs-8 col-sm-8">
								<label for="department">Институт/факультет</label>
								<input type="hidden" class="form-control" id="department" name="department" placeholder="Институт математики и информатики">
							</div>
						</div>
						<div class="row">
							<div class="col-md-11 col-xs-8 col-sm-8">
								<label for="eduname">Направление/специальность</label>
								<input type="hidden" class="form-control" name="eduname" id="eduname" placeholder="ИВТ" disabled>
							</div>
						</div>
						<div class="row">
							<div class="col-md-11 col-xs-8 col-sm-8">
								<label for="eduprof">Профиль</label>
								<input type="hidden" id="eduprof" name="eduprof" class="form-control" disabled>
							</div>
						</div>
						<div class="row">
							<div class="col-md-11 col-xs-8 col-sm-8">
								<label for="eduform">Форма обучения</label>
								<input type="hidden" id="eduform" name="eduform" class="form-control" disabled>
							</div>
						</div>
						<div class="row">
							<div class="col-md-11 col-xs-8 col-sm-8">
								<label for="eduprior">Приоритетность поступления</label>
								<select id="eduprior" name="eduprior" class="form-control" disabled>
									<option value="high">Высокий
									<option value="normal">Средний
									<option value="low">Низкий
								</select>
							</div>
						</div>
						</br>
						<div class="row">
							<div class="col-md-9 col-xs-8 col-sm-8">
								<button type="button" class="btn btn-danger pull-right" id="del">Удалить</button>
							</div>
							<div class="col-md-2 col-xs-8 col-sm-8">
								<button type="button" class="btn btn-success pull-right" id="save">Сохранить</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
{% endblock %}